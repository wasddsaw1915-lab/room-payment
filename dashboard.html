<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á (Real-time)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .table-success-custom { background-color: #d1e7dd !important; }
        .form-check-input { width: 1.6em; height: 1.6em; cursor: pointer; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn-primary { background: linear-gradient(135deg, #0d6efd 0%, #0042a5 100%) !important; border: none !important; border-radius: 12px !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary shadow">
    <div class="container">
        <span class="navbar-brand fw-bold" id="navTitle">üí∞ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á</span>
        <button class="btn btn-light btn-sm fw-bold" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</nav>

<div class="container mt-4">
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <input type="text" id="searchBox" class="form-control w-50" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="filterNames()">
                    <div id="date" class="badge bg-dark p-2 fs-6"></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="mainTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-4 text-center mb-3 border-primary border-top border-4">
                <h5 class="text-muted">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</h5>
                <h1 id="totalAmount" class="display-4 fw-bold text-primary">0 ‡∏ö‡∏≤‡∏ó</h1>
            </div>

            <div id="adminArea">
                <button onclick="exportCSV()" class="btn btn-success w-100 mb-2 py-3 fw-bold shadow-sm">üì• Export Excel + ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
                <button onclick="selectAll()" class="btn btn-primary w-100 mb-2 py-2 fw-bold shadow-sm">‚úÖ ‡∏ï‡∏¥‡πä‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button onclick="resetData()" class="btn btn-outline-danger w-100 py-2">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>

            <div id="guestArea" class="alert alert-warning d-none text-center fw-bold">
                ‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å)
            </div>
        </div>
    </div>
</div>

<script>
    const PRICE = 5;
    const members = ["‡πÅ‡∏≠‡∏°‡∏õ‡πå","‡πÄ‡∏Å‡πâ‡∏≤","‡∏ó‡πà‡∏≤‡∏ô‡∏Ñ‡∏¥‡∏ß","‡∏ó‡πà‡∏≤‡∏ô‡∏£‡∏≠‡∏á","‡πÑ‡∏≠‡∏ó‡∏µ","‡πÄ‡∏ï‡πâ","‡∏õ‡∏•‡∏∑‡πâ‡∏°","‡∏≠‡πã‡∏≠‡∏á","‡πÄ‡∏û‡∏ä‡∏£","‡∏ä‡∏≤‡∏¢","‡∏Å‡∏¥‡∏ï‡∏≤‡∏£‡πå","‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏°","‡πÄ‡∏Å‡πâ‡∏≤","‡∏ü‡∏≠‡∏£‡πå‡∏î","‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏≠‡πä‡∏ï","‡πÇ‡∏ü‡∏Å‡∏±‡∏™","‡∏ß‡∏¥‡∏ô","‡∏ô‡∏≤‡∏ô‡∏≤","‡πÅ‡∏ã‡∏ô","‡∏à‡∏¥‡πä‡∏à‡πã‡∏≤","‡πÄ‡∏°‡∏°","‡∏õ‡∏•‡∏≠‡∏¢","‡πÇ‡∏ö‡∏ß‡πå","‡∏™‡πâ‡∏°‡πÇ‡∏≠","‡∏û‡∏¥‡∏ä‡∏ä‡πà‡∏≤","‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°","‡∏ô‡πâ‡∏≥","‡∏°‡∏∞‡∏¢‡∏°","‡πÉ‡∏ö‡∏ï‡∏≠‡∏á","‡∏ï‡πâ‡∏ô‡∏´‡∏≠‡∏°"];
    
    function logout() {
        localStorage.clear();
        window.location.replace('index.html');
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA4wxFVdj6UDtxAIfG5jTUrKBM2AboT7wQ",
        authDomain: "myroompayment.firebaseapp.com",
        databaseURL: "https://myroompayment-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "myroompayment",
        storageBucket: "myroompayment.firebasestorage.app",
        messagingSenderId: "132827439147",
        appId: "1:132827439147:web:2d0c29e4076b2091e60a6e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const paidRef = ref(db, 'paid_status');

    if (localStorage.getItem('login') !== 'true') window.location.replace('index.html');
    const userRole = localStorage.getItem('role') || 'guest';
    let paid = {};

    onValue(paidRef, (snapshot) => {
        paid = snapshot.val() || {};
        renderTable();
    });

    window.togglePaid = async function(i) {
        if (userRole === 'guest') return;
        paid[i] = !paid[i];
        await set(paidRef, paid);
    }

    window.selectAll = async function() {
        if (userRole === 'guest') return;
        if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡∏¥‡πä‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            members.forEach((_, i) => { paid[i] = true; });
            await set(paidRef, paid);
        }
    }

    window.resetData = async function() {
        if (userRole === 'guest') return;
        if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏´‡∏°‡πà?")) {
            await set(paidRef, {});
        }
    }

    function renderTable() {
        const tableBody = document.getElementById('mainTable');
        if (!tableBody) return;
        tableBody.innerHTML = "";
        
        members.forEach((name, i) => {
            const row = document.createElement('tr');
            if (paid[i]) row.classList.add('table-success-custom');
            const disabled = (userRole === 'guest') ? 'disabled' : '';
            
            row.innerHTML = `
                <td>${i + 1}</td>
                <td class="fw-medium">${name}</td>
                <td class="text-center">
                    <input type="checkbox" class="form-check-input" ${paid[i] ? 'checked' : ''} 
                    ${disabled} onchange="togglePaid(${i})">
                </td>
            `;
            tableBody.appendChild(row);
        });
        updateSummary();
    }

    function updateSummary() {
        let count = Object.values(paid).filter(v => v === true).length;
        document.getElementById('totalAmount').innerText = `${count * PRICE} ‡∏ö‡∏≤‡∏ó`;
        if (userRole === 'guest') {
            document.getElementById('adminArea').classList.add('d-none');
            document.getElementById('guestArea').classList.remove('d-none');
        }
    }

    setInterval(() => {
        const dateEl = document.getElementById('date');
        if (dateEl) dateEl.innerText = new Date().toLocaleString('th-TH');
    }, 1000);

    window.filterNames = function() {
        let input = document.getElementById('searchBox').value.toUpperCase();
        let rows = document.getElementById('mainTable').getElementsByTagName('tr');
        for (let row of rows) {
            let name = row.getElementsByTagName('td')[1].innerText;
            row.style.display = name.toUpperCase().indexOf(input) > -1 ? "" : "none";
        }
    }

    window.exportCSV = function() {
        let rows = ['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢'];
        let count = 0;
        members.forEach((n, i) => {
            const isPaid = paid[i] ? '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '-';
            if (paid[i]) count++; 
            rows.push(`${i + 1},${n},${isPaid}`);
        });
        let blob = new Blob(['\uFEFF' + rows.join('\n')], { type: 'text/csv;charset=utf-8' });
        let a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á.csv`;
        a.click();
    }
</script>
</body>
</html>
