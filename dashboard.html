<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BWIT Dashboard Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        
        :root {
            --primary: #ffcc00;
            --dark: #2d3436;
            --light-bg: #f1f2f6;
            --nav-height: 60px;
            --admin-bar-height: 80px;
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--light-bg); 
            margin: 0; padding-top: var(--nav-height); 
            padding-bottom: var(--admin-bar-height);
            overflow-x: hidden;
        }

        /* Fixed Navbar */
        .main-nav {
            position: fixed; top: 0; width: 100%; height: var(--nav-height);
            background: var(--dark); color: white; display: flex;
            align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 2000; border-bottom: 3px solid var(--primary);
        }

        /* Summary Header */
        .header-section {
            background: white; padding: 20px; border-radius: 0 0 25px 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        /* List Area */
        .content-area { padding: 0 15px; }
        .list-card {
            background: white; border-radius: 15px; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Row Styles */
        .member-row {
            display: grid; grid-template-columns: 50px 1fr 60px;
            align-items: center; padding: 12px; border-bottom: 1px solid #eee;
            transition: background 0.2s; cursor: pointer;
        }
        .member-row.paid { background-color: rgba(255, 204, 0, 0.1); }
        .member-row.exempt { background-color: #f8f9fa; opacity: 0.6; }

        /* Floating Admin Action Bar */
        .admin-footer {
            position: fixed; bottom: 0; width: 100%; height: var(--admin-bar-height);
            background: white; border-top: 1px solid #ddd;
            display: flex; align-items: center; justify-content: space-around;
            padding: 0 15px; z-index: 2000;
        }

        .btn-round { border-radius: 12px; font-weight: bold; padding: 10px 15px; }
        
        /* Utility */
        .qr-box { width: 50px; height: 50px; border: 2px solid var(--primary); border-radius: 8px; }
    </style>
</head>
<body>

    <nav class="main-nav">
        <div class="d-flex align-items-center">
            <img src="LOGO.png" height="35" class="me-2" onerror="this.src='https://via.placeholder.com/35'">
            <span class="fw-bold">BWIT FUND</span>
        </div>
        <button class="btn btn-sm btn-danger" onclick="logout()">‡∏≠‡∏≠‡∏Å</button>
    </nav>

    <div class="header-section">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                <h2 class="fw-bold mb-0" id="netDisplay">0 ‡∏ø</h2>
                <span class="badge bg-success" id="incomeLabel">‡∏£‡∏±‡∏ö: 0</span>
                <span class="badge bg-danger" id="expenseLabel">‡∏à‡πà‡∏≤‡∏¢: 0</span>
            </div>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=PROMPTPAY_DATA" class="qr-box" onclick="alert('Scan to Pay')">
        </div>
    </div>

    <div class="content-area container">
        <div class="d-flex gap-2 mb-3">
            <input type="text" id="searchInp" class="form-control btn-round border-0 shadow-sm" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô..." onkeyup="ui.render()">
            <button class="btn btn-warning btn-round shadow-sm" onclick="ui.setFilter('unpaid')">‡∏Ñ‡πâ‡∏≤‡∏á</button>
        </div>

        <div class="list-card" id="listContainer">
            </div>
    </div>

    <div id="adminPanel" class="admin-footer d-none">
        <button class="btn btn-warning btn-round flex-grow-1" onclick="actions.payAll()">‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö</button>
        <button class="btn btn-outline-dark btn-round" onclick="actions.downloadCSV()">üì•</button>
        <button class="btn btn-outline-dark btn-round" onclick="actions.addExp()">üí∏</button>
        <button class="btn btn-outline-danger btn-round" onclick="actions.reset()">üîÑ</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // --- Configuration ---
    const config = {
        apiKey: "AIzaSyA4wxFVdj6UDtxAIfG5jTUrKBM2AboT7wQ",
        databaseURL: "https://myroompayment-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "myroompayment",
    };
    const app = initializeApp(config);
    const db = getDatabase(app);
    const dbRef = ref(db, 'v4_stable_data');

    const MEMBERS = ["‡πÅ‡∏≠‡∏°‡∏õ‡πå","‡πÄ‡∏Å‡πã‡∏≤","‡∏ó‡πà‡∏≤‡∏ô‡∏Ñ‡∏¥‡∏ß","‡∏ó‡πà‡∏≤‡∏ô‡∏£‡∏≠‡∏á","‡πÑ‡∏≠‡∏ó‡∏µ","‡πÄ‡∏ï‡πâ","‡∏õ‡∏•‡∏∑‡πâ‡∏°","‡∏≠‡πã‡∏≠‡∏á","‡πÄ‡∏û‡∏ä‡∏£","‡∏ä‡∏≤‡∏¢","‡∏Å‡∏¥‡∏ï‡∏≤‡∏£‡πå","‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏°","‡πÄ‡∏Å‡πâ‡∏≤","‡∏ü‡∏≠‡∏£‡πå‡∏î","‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏≠‡πä‡∏ï","‡πÇ‡∏ü‡∏Å‡∏±‡∏™","‡∏ß‡∏¥‡∏ô","‡∏ô‡∏≤‡∏ô‡∏≤","‡πÅ‡∏ã‡∏ô","‡∏à‡∏¥‡πä‡∏à‡πã‡∏≤","‡πÄ‡∏°‡∏°","‡∏õ‡∏•‡∏≠‡∏¢","‡πÇ‡∏ö‡∏ß‡πå","‡∏™‡πâ‡∏°‡πÇ‡∏≠","‡∏û‡∏¥‡∏ä‡∏ä‡πà‡∏≤","‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°","‡∏ô‡πâ‡∏≥","‡∏°‡∏∞‡∏¢‡∏°","‡πÉ‡∏ö‡∏ï‡∏≠‡∏á","‡∏ï‡πâ‡∏ô‡∏´‡∏≠‡∏°"];
    
    // --- State ---
    let state = {
        data: { paid: {}, times: {}, admins: {}, exp: 0 },
        filter: 'all',
        role: localStorage.getItem('role') || 'guest',
        adminName: localStorage.getItem('adminName') || 'Guest'
    };

    // --- UI Engine ---
    const ui = {
        render: () => {
            const container = document.getElementById('listContainer');
            const search = document.getElementById('searchInp').value.toLowerCase();
            let html = "";

            MEMBERS.forEach((name, i) => {
                const status = state.data.paid?.[i];
                if (state.filter === 'unpaid' && status === 'paid') return;
                if (search && !name.toLowerCase().includes(search)) return;

                const rowClass = status === 'paid' ? 'paid' : (status === 'exempt' ? 'exempt' : '');
                html += `
                    <div class="member-row ${rowClass}" onclick="actions.toggle(${i})">
                        <div class="text-muted small">#${i+1}</div>
                        <div>
                            <div class="fw-bold">${name}</div>
                            ${status === 'paid' ? `<small class="text-muted">‚è∞ ${state.data.times[i]} | By: ${state.data.admins[i]}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <input type="checkbox" class="form-check-input" ${status==='paid'?'checked':''} readonly>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            ui.updateStats();
        },
        updateStats: () => {
            const paidCount = Object.values(state.data.paid || {}).filter(v => v === 'paid').length;
            const income = paidCount * 5;
            const expense = state.data.exp || 0;
            document.getElementById('netDisplay').innerText = `${income - expense} ‡∏ø`;
            document.getElementById('incomeLabel').innerText = `‡∏£‡∏±‡∏ö: ${income}`;
            document.getElementById('expenseLabel').innerText = `‡∏à‡πà‡∏≤‡∏¢: ${expense}`;
            
            if(state.role === 'admin') document.getElementById('adminPanel').classList.remove('d-none');
        },
        setFilter: (f) => { state.filter = state.filter === f ? 'all' : f; ui.render(); }
    };

    // --- Actions ---
    window.actions = {
        toggle: async (i) => {
            if(state.role !== 'admin') return;
            const current = state.data.paid?.[i];
            let next = !current ? 'paid' : (current === 'paid' ? 'exempt' : null);
            
            const updates = {};
            updates[`paid/${i}`] = next;
            updates[`times/${i}`] = next === 'paid' ? new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}) : null;
            updates[`admins/${i}`] = next ? state.adminName : null;
            await update(dbRef, updates);
        },
        addExp: async () => {
            const val = prompt("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢:");
            if(val && !isNaN(val)) await update(dbRef, { exp: (state.data.exp || 0) + parseInt(val) });
        },
        reset: async () => {
            if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ?")) await set(dbRef, { exp: state.data.exp });
        },
        payAll: async () => {
            const up = {};
            MEMBERS.forEach((_, i) => { 
                up[`paid/${i}`] = 'paid'; 
                up[`times/${i}`] = '08:00'; 
                up[`admins/${i}`] = state.adminName; 
            });
            await update(dbRef, up);
        },
        downloadCSV: () => {
            let csv = "\uFEFF‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n";
            MEMBERS.forEach((n, i) => csv += `${i+1},${n},${state.data.paid?.[i] || '‡∏Ñ‡πâ‡∏≤‡∏á'}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'report.csv'; a.click();
        }
    };

    // --- Initialize ---
    onValue(dbRef, (snap) => {
        state.data = snap.val() || { paid: {}, times: {}, admins: {}, exp: 0 };
        ui.render();
    });

    window.logout = () => { localStorage.clear(); window.location.href = 'index.html'; };

</script>
</body>
</html>
