<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BWIT Fund Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; padding-bottom: 120px; }
        .navbar { background: #4a4a4a !important; border-bottom: 4px solid #ffcc00; }
        .summary-card { background: white; border-radius: 20px; padding: 20px; margin-top: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: #ffcc00; }
        .table-container { background: white; border-radius: 20px; overflow: hidden; margin-top: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .paid-row { background-color: rgba(255, 204, 0, 0.1) !important; }
        .exempt-row { background-color: #eee !important; opacity: 0.6; text-decoration: line-through; }
        .admin-bar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: white; padding: 12px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; gap: 8px; z-index: 9999; }
        .qr-img { width: 55px; height: 55px; border: 2px solid #ffcc00; border-radius: 10px; cursor: pointer; }
        .admin-tag { font-size: 0.65rem; color: #888; background: #f0f0f0; padding: 2px 5px; border-radius: 4px; }
        @media print { .navbar, .admin-bar, .search-box, .btn-sm { display: none !important; } }
    </style>
</head>
<body>

<nav class="navbar navbar-dark sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="navbar-brand fw-bold d-flex align-items-center">
            <img src="LOGO.png" width="35" height="35" class="me-2">
            <span>‡∏ö‡∏∂‡∏á‡∏™‡∏≤‡∏°‡∏û‡∏±‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</span>
        </div>
        <button class="btn btn-sm btn-danger rounded-pill" onclick="logout()">‡∏≠‡∏≠‡∏Å</button>
    </div>
</nav>

<div class="container">
    <div class="summary-card">
        <div class="row align-items-center">
            <div class="col-8">
                <small class="text-muted">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠</small>
                <div id="netBalance" class="stat-val">0 ‡∏ø</div>
                <div class="small">‡∏£‡∏±‡∏ö: <span id="totalIn" class="text-success">0</span> | ‡∏à‡πà‡∏≤‡∏¢: <span id="totalOut" class="text-danger">0</span></div>
            </div>
            <div class="col-4 text-center">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=08XXXXXXXX" class="qr-img" onclick="alert('‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢ PromptPay')">
                <div style="font-size: 0.5rem;">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢</div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <input type="text" id="searchBox" class="form-control rounded-pill shadow-sm mb-2" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô..." onkeyup="renderTable()">
        <div class="d-flex gap-1 overflow-auto pb-1">
            <button class="btn btn-sm btn-light border px-3" onclick="setFilter('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="btn btn-sm btn-light border px-3 text-danger" onclick="setFilter('unpaid')">‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢</button>
            <button class="btn btn-sm btn-warning px-3" onclick="addExpense()">üí∏ ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-hover mb-0">
            <tbody id="mainTable"></tbody>
        </table>
    </div>
</div>

<div id="adminArea" class="admin-bar d-none">
    <button onclick="selectAll()" class="btn btn-warning flex-grow-1 fw-bold rounded-pill">‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö</button>
    <button onclick="exportCSV()" class="btn btn-light border rounded-pill">üì• CSV</button>
    <button onclick="window.print()" class="btn btn-light border rounded-pill">üñ®Ô∏è PDF</button>
    <button onclick="resetData()" class="btn btn-outline-danger rounded-pill">üîÑ ‡∏•‡πâ‡∏≤‡∏á</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA4wxFVdj6UDtxAIfG5jTUrKBM2AboT7wQ",
        authDomain: "myroompayment.firebaseapp.com",
        databaseURL: "https://myroompayment-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "myroompayment",
        storageBucket: "myroompayment.firebasestorage.app",
        messagingSenderId: "132827439147",
        appId: "1:132827439147:web:2d0c29e4076b2091e60a6e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dataRef = ref(db, 'class_fund_vFinal');

    const members = ["‡πÅ‡∏≠‡∏°‡∏õ‡πå","‡πÄ‡∏Å‡πã‡∏≤","‡∏ó‡πà‡∏≤‡∏ô‡∏Ñ‡∏¥‡∏ß","‡∏ó‡πà‡∏≤‡∏ô‡∏£‡∏≠‡∏á","‡πÑ‡∏≠‡∏ó‡∏µ","‡πÄ‡∏ï‡πâ","‡∏õ‡∏•‡∏∑‡πâ‡∏°","‡∏≠‡πã‡∏≠‡∏á","‡πÄ‡∏û‡∏ä‡∏£","‡∏ä‡∏≤‡∏¢","‡∏Å‡∏¥‡∏ï‡∏≤‡∏£‡πå","‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏°","‡πÄ‡∏Å‡πâ‡∏≤","‡∏ü‡∏≠‡∏£‡πå‡∏î","‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏≠‡πä‡∏ï","‡πÇ‡∏ü‡∏Å‡∏±‡∏™","‡∏ß‡∏¥‡∏ô","‡∏ô‡∏≤‡∏ô‡∏≤","‡πÅ‡∏ã‡∏ô","‡∏à‡∏¥‡πä‡∏à‡πã‡∏≤","‡πÄ‡∏°‡∏°","‡∏õ‡∏•‡∏≠‡∏¢","‡πÇ‡∏ö‡∏ß‡πå","‡∏™‡πâ‡∏°‡πÇ‡∏≠","‡∏û‡∏¥‡∏ä‡∏ä‡πà‡∏≤","‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°","‡∏ô‡πâ‡∏≥","‡∏°‡∏∞‡∏¢‡∏°","‡πÉ‡∏ö‡∏ï‡∏≠‡∏á","‡∏ï‡πâ‡∏ô‡∏´‡∏≠‡∏°"];
    const userRole = localStorage.getItem('role') || 'guest';
    const adminName = localStorage.getItem('adminName') || 'Guest';
    let currentFilter = 'all';
    let roomData = { paid_status: {}, times: {}, admins: {}, expenses: 0 };

    onValue(dataRef, (snapshot) => {
        roomData = snapshot.val() || { paid_status: {}, times: {}, admins: {}, expenses: 0 };
        renderTable();
        updateStats();
    });

    window.togglePaid = async (i) => {
        if (userRole === 'guest') return;
        const s = roomData.paid_status[i];
        let next = !s ? "paid" : (s === "paid" ? "exempt" : null);
        const up = {};
        up[`paid_status/${i}`] = next;
        up[`times/${i}`] = next === "paid" ? new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}) : null;
        up[`admins/${i}`] = next ? adminName : null;
        await update(dataRef, up);
    };

    function renderTable() {
        const tbody = document.getElementById('mainTable');
        tbody.innerHTML = "";
        const search = document.getElementById('searchBox').value.toLowerCase();

        members.forEach((name, i) => {
            const status = roomData.paid_status[i];
            if (currentFilter === 'paid' && status !== 'paid') return;
            if (currentFilter === 'unpaid' && status === 'paid') return;
            if (search && !name.toLowerCase().includes(search)) return;

            const row = document.createElement('tr');
            if (status === 'paid') row.className = 'paid-row';
            if (status === 'exempt') row.className = 'exempt-row';

            row.innerHTML = `
                <td width="50" class="text-center small text-muted">#${i+1}</td>
                <td onclick="togglePaid(${i})">
                    <div class="fw-bold">${name}</div>
                    <div class="d-flex gap-2">
                        ${status === 'paid' ? `<span class="small text-muted">‚è∞ ${roomData.times[i]}</span>` : ''}
                        ${roomData.admins[i] ? `<span class="admin-tag">‡πÇ‡∏î‡∏¢: ${roomData.admins[i]}</span>` : ''}
                    </div>
                </td>
                <td width="50" class="text-center">
                    <input type="checkbox" class="form-check-input" ${status==='paid'?'checked':''} ${userRole==='guest'?'disabled':''}>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function updateStats() {
        const count = Object.values(roomData.paid_status || {}).filter(v => v === 'paid').length;
        const income = count * 5;
        const expense = roomData.expenses || 0;
        document.getElementById('totalIn').innerText = income;
        document.getElementById('totalOut').innerText = expense;
        document.getElementById('netBalance').innerText = (income - expense) + " ‡∏ø";
        if (userRole !== 'guest') document.getElementById('adminArea').classList.remove('d-none');
    }

    window.addExpense = async () => {
        if (userRole === 'guest') return;
        const amt = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢:");
        if (amt && !isNaN(amt)) await update(dataRef, { expenses: (roomData.expenses || 0) + parseInt(amt) });
    };

    window.exportCSV = () => {
        let csv = "\uFEFF‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡πÄ‡∏ß‡∏•‡∏≤,Admin\n";
        members.forEach((n, i) => csv += `${i+1},${n},${roomData.paid_status[i] || '‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢'},${roomData.times[i] || '-'},${roomData.admins[i] || '-'}\n`);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á.csv';
        a.click();
    };

    window.resetData = async () => { if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå?")) await set(dataRef, { expenses: roomData.expenses }); };
    window.logout = () => { localStorage.clear(); window.location.replace('index.html'); };
    window.setFilter = (f) => { currentFilter = f; renderTable(); };
    window.selectAll = async () => {
        const up = {};
        members.forEach((_, i) => { up[`paid_status/${i}`] = "paid"; up[`times/${i}`] = "08:00"; up[`admins/${i}`] = adminName; });
        await update(dataRef, up);
    };
</script>
</body>
</html>
