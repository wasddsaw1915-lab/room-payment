<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .table-success-custom { background-color: #d1e7dd !important; }
        .form-check-input { width: 1.6em; height: 1.6em; cursor: pointer; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<audio id="soundSuccess" src="https://www.soundjay.com/buttons/sounds/button-10.mp3"></audio>
<audio id="soundReset" src="https://www.soundjay.com/buttons/sounds/button-11.mp3"></audio>

<nav class="navbar navbar-dark bg-primary shadow">
    <div class="container">
        <span class="navbar-brand fw-bold" id="navTitle">üí∞ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á</span>
        <button class="btn btn-light btn-sm fw-bold" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</nav>

<div class="container mt-4">
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <input type="text" id="searchBox" class="form-control w-50" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="filterNames()">
                    <div id="date" class="badge bg-dark p-2 fs-6"></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="mainTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-4 text-center mb-3 border-primary border-top border-4">
                <h5 class="text-muted">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</h5>
                <h1 id="totalAmount" class="display-4 fw-bold text-primary">0 ‡∏ö‡∏≤‡∏ó</h1>
            </div>

            <div id="adminArea">
                <button onclick="exportCSV()" class="btn btn-success w-100 mb-2 py-3 fw-bold shadow-sm">üì• Export Excel + ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
                <button onclick="resetData()" class="btn btn-outline-danger w-100 py-2">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>

            <div id="guestArea" class="alert alert-warning d-none text-center fw-bold">
                ‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å)
            </div>
        </div>
    </div>
</div>

<script src="js/data.js"></script>
<script src="js/login.js"></script>
<script src="js/export.js"></script>
<script>
    // ‡∏î‡∏∂‡∏á URL ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxHFMKkcMQmOXJ44zQtWSLHp4p2N8ZDCiwMeV5ey2GnOPXame5MMPydEYQICIldlgcb7g/exec'; 

    if (localStorage.getItem('login') !== 'true') window.location.replace('index.html');
    
    const userRole = localStorage.getItem('role') || 'guest';
    let paid = {}; 

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
    async function loadData() {
        try {
            const response = await fetch(`${scriptURL}?t=${new Date().getTime()}`);
            const data = await response.json();
            paid = data || {};
            renderTable();
        } catch (e) {
            console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", e);
            renderTable();
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
    function renderTable() {
        const tableBody = document.getElementById('mainTable');
        tableBody.innerHTML = "";
        members.forEach((name, i) => {
            const row = document.createElement('tr');
            if (paid[i]) row.classList.add('table-success-custom');
            const disabled = (userRole === 'guest') ? 'disabled' : '';
            
            row.innerHTML = `
                <td>${i + 1}</td>
                <td class="fw-medium">${name}</td>
                <td class="text-center">
                    <input type="checkbox" class="form-check-input" ${paid[i] ? 'checked' : ''} 
                    ${disabled} onchange="togglePaid(${i})">
                </td>
            `;
            tableBody.appendChild(row);
        });
        updateSummary();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏¥‡πä‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    async function togglePaid(i) {
        if (userRole === 'guest') return;
        
        if (!paid[i]) {
            document.getElementById('soundSuccess').play().catch(() => {});
        }
        
        paid[i] = !paid[i];
        renderTable();
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà Google
        try {
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(paid)
            });
        } catch (e) { console.error(e); }
    }

    function updateSummary() {
        let count = Object.values(paid).filter(v => v === true).length;
        document.getElementById('totalAmount').innerText = `${count * PRICE} ‡∏ö‡∏≤‡∏ó`;
        if (userRole === 'guest') {
            document.getElementById('adminArea').classList.add('d-none');
            document.getElementById('guestArea').classList.remove('d-none');
        }
    }

    function resetData() {
        if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
            document.getElementById('soundReset').play().catch(() => {});
            paid = {};
            renderTable();
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google
            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({}) });
        }
    }

    function filterNames() {
        let input = document.getElementById('searchBox').value.toUpperCase();
        let rows = document.getElementById('mainTable').getElementsByTagName('tr');
        for (let row of rows) {
            let name = row.getElementsByTagName('td')[1].innerText;
            row.style.display = name.toUpperCase().indexOf(input) > -1 ? "" : "none";
        }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    setInterval(() => { document.getElementById('date').innerText = new Date().toLocaleString('th-TH'); }, 1000);
    loadData();
    setInterval(loadData, 30000); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
</script>
</body>
</html>
